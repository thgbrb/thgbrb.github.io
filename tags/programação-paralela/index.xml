<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>ProgramaÃ§Ã£o Paralela on Î» JogaNaContaDaInfra</title>
        <link>https://joganacontadainfra.com.br/tags/programa%C3%A7%C3%A3o-paralela/</link>
        <description>Recent content in ProgramaÃ§Ã£o Paralela on Î» JogaNaContaDaInfra</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>pt-br</language>
        <lastBuildDate>Thu, 15 Jul 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://joganacontadainfra.com.br/tags/programa%C3%A7%C3%A3o-paralela/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>Cachelines e False Sharing</title>
        <link>https://joganacontadainfra.com.br/p/cache-line-false-sharing/</link>
        <pubDate>Thu, 15 Jul 2021 00:00:00 +0000</pubDate>
        
        <guid>https://joganacontadainfra.com.br/p/cache-line-false-sharing/</guid>
        <description>&lt;img src="https://joganacontadainfra.com.br/p/cache-line-false-sharing/cacheline.png" alt="Featured image of post Cachelines e False Sharing" /&gt;&lt;h2 id=&#34;cpu-cache&#34;&gt;CPU Cache
&lt;/h2&gt;&lt;p&gt;Os processadores possuem estratÃ©gias de caching para manter as prÃ³ximas instruÃ§Ãµes a serem executadas e blocos
de dados a serem manipulados o mais prÃ³ximo de uma thread, economizando ciclos para buscar dados na memÃ³ria RAM; busca que no contexto de CPU Ã© extremamente lento.
O cache de CPU Ã© distribuÃ­do em nÃ­veis, onde L1 Ã© um cache muito pequeno exclusivo para um core e compartilhado com as suas threads e o L2 Ã© um
cache um pouco maior compartilhado por um grupo de core.&lt;/p&gt;
&lt;h3 id=&#34;cacheline&#34;&gt;Cacheline
&lt;/h3&gt;&lt;p&gt;O processador busca dados na memÃ³ria em blocos e nÃ£o â€˜byteâ€™ a â€˜byteâ€™. Esses blocos de dados sÃ£o chamados de cacheline.
Quando o processador lÃª um determinado ponto da memÃ³ria ele busca, a partir desse ponto,
a quantidade de dados equivalentes ao tamanho da cacheline.
Em mÃ©dia uma linha de cache possui 64 â€˜bytesâ€™, variando de acordo com a arquitetura do processador. Quanto maior o tamanho do cache
maior Ã© quantidade de linhas, ou seja, menor Ã© quantidade de leituras na memÃ³ria RAM.&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;Processador&lt;/th&gt;
          &lt;th&gt;Cache L1&lt;/th&gt;
          &lt;th&gt;Cache L2&lt;/th&gt;
          &lt;th&gt;Cache L3&lt;/th&gt;
          &lt;th&gt;LanÃ§amento&lt;/th&gt;
          &lt;th&gt;PreÃ§o&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;i7-9750H&lt;/td&gt;
          &lt;td&gt;32K&lt;/td&gt;
          &lt;td&gt;256K&lt;/td&gt;
          &lt;td&gt;12M&lt;/td&gt;
          &lt;td&gt;2019&lt;/td&gt;
          &lt;td&gt;~USD 395&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;Xeon E5-2620&lt;/td&gt;
          &lt;td&gt;384K&lt;/td&gt;
          &lt;td&gt;1,5M&lt;/td&gt;
          &lt;td&gt;15M&lt;/td&gt;
          &lt;td&gt;2012&lt;/td&gt;
          &lt;td&gt;~USD 410&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Tamanho do cache e cacheline&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Para verificar o tamanho do cache e cacheline em uma mÃ¡quina com Windows, &lt;a class=&#34;link&#34; href=&#34;https://docs.microsoft.com/en-us/sysinternals/downloads/coreinfo&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;utilize o aplicativo Coreinfo da Sysinternal.&lt;/a&gt;
&lt;img src=&#34;https://joganacontadainfra.com.br/p/cache-line-false-sharing/coreinfo.png&#34;
	width=&#34;714&#34;
	height=&#34;393&#34;
	srcset=&#34;https://joganacontadainfra.com.br/p/cache-line-false-sharing/coreinfo_hu_e5541945eec6cbdc.png 480w, https://joganacontadainfra.com.br/p/cache-line-false-sharing/coreinfo_hu_d5035bfa64150ede.png 1024w&#34;
	loading=&#34;lazy&#34;
	
		alt=&#34;ExecuÃ§Ã£o do Coreinfo&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;181&#34;
		data-flex-basis=&#34;436px&#34;
	
&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;h3 id=&#34;cache-coherence-protocol&#34;&gt;Cache coherence protocol
&lt;/h3&gt;&lt;p&gt;As CPUs modernas na sua maioria possuem mais de uma thread por core, utilizando tÃ©cnicas de programaÃ§Ã£o paralela.
Uma das estratÃ©gias Ã© utilizar as micropausas de uma thread fÃ­sica (ex.: buscar dados na memÃ³ria RAM) para que outra thread
execute alguma operaÃ§Ã£o.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Tecnologia proprietÃ¡ria&lt;/p&gt;
&lt;p&gt;Cada fornecedor define a sua tecnologia para maximizar o desempenho de um processador.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://www.intel.com.br/content/www/br/pt/gaming/resources/hyper-threading.html&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Intel Hyper-thread&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class=&#34;link&#34; href=&#34;https://www.amd.com/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;AMD Simultaneous Multithreading&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/blockquote&gt;
&lt;p&gt;As threads fÃ­sicas compartilham o cache L1 exclusivo do seu core, assim como o cache L2, que Ã© compartilhado por um grupo de core e outros
nÃ­veis de cache possam existir. Por fim, acima dessa estrutura de cache, existe a memÃ³ria RAM.&lt;/p&gt;
&lt;figure&gt;&lt;img src=&#34;https://joganacontadainfra.com.br/p/cache-line-false-sharing/800px-Non_Coherent.gif&#34; width=&#34;500&#34;&gt;&lt;figcaption&gt;
      &lt;h4&gt;Uso de cache sem coerÃªncia/integridade (fig wikipÃ©dia)&lt;/h4&gt;
    &lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Dado o cenÃ¡rio de paralelismo, a CPU deve implementar estratÃ©gias de sincronizaÃ§Ã£o desses dados para evitar o problema demonstrado na imagem acima.
Essa estratÃ©gia Ã© chamada de &lt;strong&gt;Cache coherence protocol&lt;/strong&gt;. Esse protocolo Ã© responsÃ¡vel por manter a coerÃªncia e integridade no cache.&lt;/p&gt;
&lt;figure&gt;&lt;img src=&#34;https://joganacontadainfra.com.br/p/cache-line-false-sharing/800px-Coherent.gif&#34; width=&#34;500&#34;&gt;&lt;figcaption&gt;
      &lt;h4&gt;EstratÃ©gia de coerÃªncia (fig wikipÃ©dia)&lt;/h4&gt;
    &lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&#34;otimizaÃ§Ã£o-de-compiladores&#34;&gt;OtimizaÃ§Ã£o de compiladores
&lt;/h3&gt;&lt;p&gt;Os compiladores modernos alÃ©m gerarem cÃ³digos que utilizam os recursos fornecidos pelas CPUs tambÃ©m implementam estratÃ©gias e tÃ©cnicas
de otimizaÃ§Ã£o, com o objetivo de extrair o mÃ¡ximo do hardware. PorÃ©m, nem sempre os compiladores conseguem gerar o cÃ³digo mais performÃ¡tico
por uma sÃ©rie de motivos, que sozinhos sÃ£o tema de um futuro post.
Dificilmente esses problemas sÃ£o detectados nos processos de desenvolvimento e/ou qualidade. NÃ£o Ã© incomum que eles ocorram somente em
produÃ§Ã£o de forma nÃ£o determinÃ­stica.&lt;/p&gt;
&lt;h2 id=&#34;false-sharing&#34;&gt;False sharing
&lt;/h2&gt;&lt;p&gt;Em algumas situaÃ§Ãµes o cÃ³digo de um programador nÃ£o consegue ser otimizado pelo compilador, o que introduz problemas
de desempenho ou atÃ© mesmo falhas. Uma dessas situaÃ§Ãµes Ã© o &lt;strong&gt;false sharing&lt;/strong&gt;. O false sharing ocorre quando o &lt;strong&gt;cache coherence protocol&lt;/strong&gt;
entende ser necessÃ¡rio atualizar uma determinada linha de cache, fazendo com que ocorra uma nova leitura do dado na memÃ³ria RAM.
&lt;em&gt;Lembrando que leitura de memÃ³ria RAM num contexto de CPU Ã© uma operaÃ§Ã£o lenta!&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Quando threads fÃ­sicas fazem &lt;strong&gt;leituras&lt;/strong&gt; e &lt;strong&gt;gravaÃ§Ãµes&lt;/strong&gt; &lt;strong&gt;frequentes&lt;/strong&gt; de um &lt;strong&gt;dado&lt;/strong&gt; muito &lt;strong&gt;pequeno&lt;/strong&gt; que estÃ£o alinhados na memÃ³ria RAM num cenÃ¡rio de &lt;strong&gt;paralelismo&lt;/strong&gt;
essa situaÃ§Ã£o ocorrerÃ¡.&lt;/p&gt;
&lt;p&gt;Nos exemplos abaixo temos um cÃ³digo cujo objetivo Ã© para cada posiÃ§Ã£o de um array de inteiros incrementar o valor da referÃªncia num â€˜looping forâ€™ 1.000.000 de vezes.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Foi utilizado um laptop com um processador i7-9750H para os testes.&lt;/p&gt;&lt;/blockquote&gt;
&lt;h3 id=&#34;cenÃ¡rio-a---false-sharing&#34;&gt;CenÃ¡rio A - False sharing
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;17,435&lt;/strong&gt; segundos para finalizar o processamento.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-csharp&#34; data-lang=&#34;csharp&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kd&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;readonly&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sharedArray&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kd&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;CenarioA&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task1&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task2&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task3&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task4&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;WaitAll&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;task1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kd&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;position&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;1_000_000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;++)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;n&#34;&gt;sharedArray&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;position&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]++;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;cenÃ¡rio-b---otimizaÃ§Ã£o-de-cÃ³digo&#34;&gt;CenÃ¡rio B - OtimizaÃ§Ã£o de cÃ³digo
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;5,72&lt;/strong&gt; segundos para finalizar o processamento.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-csharp&#34; data-lang=&#34;csharp&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kd&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;readonly&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sharedArray&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kd&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;CenarioB&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task1&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task2&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task3&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task4&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;48&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;Task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;WaitAll&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;task1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kd&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Inc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;position&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;1_000_000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;++)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;n&#34;&gt;sharedArray&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;position&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]++;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;benchmark-cenÃ¡rios-a-e-b&#34;&gt;Benchmark CenÃ¡rios A e B
&lt;/h3&gt;&lt;p&gt;No benchmark observamos que o CenÃ¡rio B executou aproximadamente 3x mais rÃ¡pido que o cenÃ¡rio A.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://joganacontadainfra.com.br/p/cache-line-false-sharing/benchmark.png&#34;
	width=&#34;449&#34;
	height=&#34;93&#34;
	srcset=&#34;https://joganacontadainfra.com.br/p/cache-line-false-sharing/benchmark_hu_bef0d877329cfdf2.png 480w, https://joganacontadainfra.com.br/p/cache-line-false-sharing/benchmark_hu_84b953cbb29b3ba6.png 1024w&#34;
	loading=&#34;lazy&#34;
	
		alt=&#34;Benchmark A x B&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;482&#34;
		data-flex-basis=&#34;1158px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;No CenÃ¡rioA todas as threads compartilham a mesma cacheline para leitura e gravaÃ§Ã£o. Isso faz o cache coherence protocol
invalidar diversas vezes a cacheline e consequentemente a CPU deve buscar na memÃ³ria RAM o valor atualizado.
JÃ¡ no CenÃ¡rioB utilizamos uma estratÃ©gia onde cada thread utiliza uma cacheline diferente! Para fazer isso Ã© utilizado
saltos de 16 posiÃ§Ãµes no array de inteiro, ou seja:&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;Quantidade de Int32&lt;/th&gt;
          &lt;th&gt;Tamanho Int32&lt;/th&gt;
          &lt;th&gt;Tamanho ocupado&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;16&lt;/td&gt;
          &lt;td&gt;4 bytes&lt;/td&gt;
          &lt;td&gt;16 x 4 bytes = 64 bytes&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Considerando que o processador onde o benchmark Ã© executado possui uma cacheline de 64 â€˜bytesâ€™, cada thread utilizarÃ¡ uma
cacheline diferente.&lt;/p&gt;
&lt;h2 id=&#34;conclusÃ£o&#34;&gt;ConclusÃ£o
&lt;/h2&gt;&lt;p&gt;Apesar dos compiladores ocultarem parte da complexidade da programaÃ§Ã£o paralela hÃ¡ cenÃ¡rios que precisam da intervenÃ§Ã£o do programador.
Entender como funciona alocaÃ§Ã£o de memÃ³ria na sua stack de desenvolvimento assim como conhecer o funcionamento de componentes de hardware
sÃ£o ferramentas essenciais para a escrita de cÃ³digos de alto desempenho e otimizados.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ‘‰ Dica â˜ ï¸&lt;/p&gt;
&lt;p&gt;OtimizaÃ§Ã£o prematura do cÃ³digo traz complexidade sem agregar valor! Evite :)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ¤¯ &lt;strong&gt;InformaÃ§Ã£o&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;False sharing Ã© um problema universal em processadores multithreading que compartilham cache.
O exemplo acima funciona em qualquer linguagem :)&lt;/p&gt;&lt;/blockquote&gt;
</description>
        </item>
        
    </channel>
</rss>
